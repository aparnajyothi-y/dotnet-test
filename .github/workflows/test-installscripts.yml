name: macos-arch-validation

on:
  workflow_dispatch:

jobs:
  validate-architectures:
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET (arm64 - default behavior)
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Print arm64 dotnet info
        run: |
          echo "=== ARM64 dotnet (setup-dotnet default) ==="
          dotnet --info

      - name: Install Rosetta (required for x64)
        run: |
          echo "Installing Rosetta..."
          sudo softwareupdate --install-rosetta --agree-to-license

      - name: Download x64 .NET SDK manually
        run: |
          echo "=== Downloading x64 SDK ==="
          mkdir -p manual-x64
          curl -L \
            https://dotnetcli.azureedge.net/dotnet/Sdk/8.0.416/dotnet-sdk-8.0.416-osx-x64.tar.gz \
            -o x64.tar.gz

      - name: Extract x64 SDK
        run: |
          echo "=== Extracting x64 SDK ==="
          tar -xzf x64.tar.gz -C manual-x64

      - name: Print x64 dotnet info (Rosetta)
        run: |
          echo "=== X64 dotnet (manual install under Rosetta) ==="
          ./manual-x64/dotnet --info || true
